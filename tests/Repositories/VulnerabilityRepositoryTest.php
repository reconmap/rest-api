<?php

declare(strict_types=1);

namespace Reconmap\Repositories;

use Reconmap\DatabaseTestCase;

class VulnerabilityRepositoryTest extends DatabaseTestCase
{
    private VulnerabilityRepository $subject;

    public function setUp(): void
    {
        $db = $this->getDatabaseConnection();
        $this->subject = new VulnerabilityRepository($db);
    }

    public function testFindAllReturnsAllRecords()
    {
        $vulnerabilities = $this->subject->findAll();
        $this->assertCount(20, $vulnerabilities);

        $vulnerability = $vulnerabilities[0];
        $this->assertArrayHasKey('category_name', $vulnerability);
        $this->assertArrayHasKey('cvss_score', $vulnerability);
        $this->assertArrayHasKey('cvss_vector', $vulnerability);
    }

    public function testFindByIdReturnsProjectInfo()
    {
        $vulnerability = $this->subject->findById(1);
        $this->assertEquals('Web server pentest project', $vulnerability['project_name']);
    }

    public function testReturnedTotalTypesAreNotString()
    {
        $stats = $this->subject->findCountByCategory();
        $this->assertIsInt($stats[0]['total']);
    }
}
