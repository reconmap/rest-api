using api_v2.Infrastructure.Persistence;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using StackExchange.Redis;

namespace api_v2.Controllers;

public class RiskCountDto
{
    public string Risk { get; set; } = string.Empty;
    public int Total { get; set; }
}

public class CategoryCountDto
{
    public string CategoryName { get; set; } = string.Empty;
    public int Total { get; set; }
}

[Route("api/vulnerabilities/stats")]
[ApiController]
public class VulnerabilityStatsController(
    AppDbContext dbContext,
    ILogger<VulnerabilityStatsController> logger,
    IConnectionMultiplexer redisConnections)
    : AppController(dbContext)
{
    [HttpGet]
    public async Task<IActionResult> GetStats([FromQuery] int? projectId = null, [FromQuery] string? groupBy = null)
    {
        if (groupBy != null) return Ok(await FindCountByRiskAsync(projectId));

        return Ok(await FindCountByCategoryAsync(projectId));
    }

    private async Task<List<RiskCountDto>> FindCountByRiskAsync(int? projectId = null)
    {
        var query = dbContext.Vulnerabilities.AsQueryable();

        if (projectId.HasValue)
            query = query.Where(v => v.ProjectId == projectId.Value);

        return await query
            .GroupBy(v => v.Risk)
            .Select(g => new RiskCountDto
            {
                Risk = g.Key,
                Total = g.Count()
            })
            .OrderByDescending(x => x.Total)
            .ToListAsync();
    }

    private async Task<List<CategoryCountDto>> FindCountByCategoryAsync(int? projectId = null)
    {
        var query = dbContext.Vulnerabilities
            .Include(v => v.Category)
            .Where(v => v.Category.ParentId == null)
            .AsQueryable();

        if (projectId.HasValue)
            query = query.Where(v => v.ProjectId == projectId.Value);

        return await query
            .GroupBy(v => v.Category.Name)
            .Select(g => new CategoryCountDto
            {
                CategoryName = g.Key,
                Total = g.Count()
            })
            .OrderByDescending(x => x.Total)
            .ToListAsync();
    }
}
